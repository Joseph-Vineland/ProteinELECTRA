# ProteinELECTRA

## Introduction

ProteinELECTRA is a method for self-supervised protein language representation learning and for protein sequence processing tasks such as the [Tasks Assessing Protein Embeddings (TAPE)](https://github.com/songlab-cal/tape).  It can be used to pre-train transformer networks using relatively little compute. ProteinELECTRA models are trained to distinguish "real" input tokens vs "fake" input tokens generated by another neural network, similar to the discriminator of a [GAN](https://arxiv.org/pdf/1406.2661.pdf). At small scale, ProteinELECTRA achieves strong results even when trained on a single GPU.

Refer to the original ELECTRA repository here: https://github.com/google-research/electra

Refer to the original ELECTRA paper here: https://openreview.net/pdf?id=r1xMH1BtvB

Refer to my blog on ProteinELECTRA here: https://joseph-vineland.github.io/2022/07/21/Learn-the-Language-of-Proteins-Efficiently-with-ELECTRA.html

## Requirements
* Python 3
* [TensorFlow](https://www.tensorflow.org/) 1.15 (although we hope to support TensorFlow 2.0 at a future date)
* [NumPy](https://numpy.org/)
* [scikit-learn](https://scikit-learn.org/stable/) and [SciPy](https://www.scipy.org/) (for computing some evaluation metrics).

## Installation
```
git clone https://github.com/Joseph-Vineland/ProteinELECTRA.git
cd ProteinELECTRA
pip install gdown
gdown https://drive.google.com/uc?id=1oIdLozvULpLPtX6owSlJNDmJi-BRQXF7
tar -xzvf TAPE.tar.gz
```

##  Quickstart: ProteinELECTRA & Tasks Assessing Protein Embeddings (TAPE)

#### Pre-training
These instructions pre-train a ProteinELECTRA model using the TAPE pre-training corpus.  Skip this section if you would like to use the pre-trained model provided.  

1. Run `python3 build_pretraining_dataset.py --corpus-dir TAPE/corpus-dir/ --vocab-file TAPE/vocab_AAtokenized.txt --output-dir TAPE/electraBASE/pretrain_tfrecords/ --max-seq-length 512 --num-processes 6 --no-lower-case`. It pre-processes/tokenizes the data and outputs examples as [tfrecord](https://www.tensorflow.org/tutorials/load_data/tfrecord) files under `TAPE/electraBASE/pretrain_tfrecords/`. The tfrecords require roughly 50G of disk space. 

2. Run `python3 run_pretraining.py --data-dir TAPE/electraBASE --model-name quickStart` to train a ProteinELECTRA model for 1 million million steps. Modify the parameters in `configure_pretraining.py` if you want a different number of steps or a different size model, etc.

#### Fine-tuning

1. If you performed the pre-training steps above, copy the vocab file into the quickStart model directory:
`cp TAPE/vocab_AAtokenized.txt TAPE/electraBASE/models/quickStart/vocab.txt`

2. Run the following commands to fine-tune and evaluate the ProteinELECTRA model on TAPE tasks.

```
python3 run_finetuning.py --data-dir TAPE/electraBASE/ --model-name quickStart --hparams '{"model_size": "base", "task_names": ["fluorescence"]}'
python3 run_finetuning.py --data-dir TAPE/electraBASE/ --model-name quickStart --hparams '{"model_size": "base", "task_names": ["stability"]}'
python3 run_finetuning.py --data-dir TAPE/electraBASE/ --model-name quickStart --hparams '{"model_size": "base", "task_names": ["remoteHomology"]}'
python3 run_finetuning.py --data-dir TAPE/electraBASE/ --model-name quickStart --hparams '{"model_size": "base", "task_names": ["secondaryStructure"]}'
```

Replace `--model-name quickStart` with `--model-name electra_base_AA_3epochs` if you skipped pre-training and want to use the pre-trained model provided.
Evaluation is done on the dev set by default.  

## Pre-training
Use `build_pretraining_dataset.py` to create a pre-training dataset from a dump of raw text. It has the following arguments:

* `--corpus-dir`: A directory containing raw text files to turn into ELECTRA examples. A text file can contain multiple documents with empty lines separating them.
* `--vocab-file`: File defining the wordpiece vocabulary.
* `--output-dir`: Where to write out ELECTRA examples.
* `--max-seq-length`: The number of tokens per example (128 by default).
* `--num-processes`: If >1 parallelize across multiple processes (1 by default).
* `--blanks-separate-docs`: Whether blank lines indicate document boundaries (True by default).
* `--do-lower-case/--no-lower-case`: Whether to lower case the input text (True by default).

Use `run_pretraining.py` to pre-train an ELECTRA model. It has the following arguments:

* `--data-dir`: a directory where pre-training data, model weights, etc. are stored. By default, the training loads examples from `<data-dir>/pretrain_tfrecords` and a vocabulary from `<data-dir>/vocab.txt`.
*  `--model-name`: a name for the model being trained. Model weights will be saved in `<data-dir>/models/<model-name>` by default.
* `--hparams` (optional): a JSON dict or path to a JSON file containing model hyperparameters, data paths, etc. See `configure_pretraining.py` for the supported hyperparameters.

If training is halted, re-running the `run_pretraining.py` with the same arguments will continue the training where it left off.

You can continue pre-training from the released ELECTRA checkpoints by
1. Setting the model-name to point to a downloaded model (e.g., `--model-name electra_small` if you downloaded weights to `$DATA_DIR/electra_small`).
2. Setting `num_train_steps` by (for example) adding `"num_train_steps": 4010000` to the `--hparams`. This will continue training the small model for 10000 more steps (it has already been trained for 4e6 steps).
3. Increase the learning rate to account for the linear learning rate decay. For example, to start with a learning rate of 2e-4 you should set the `learning_rate` hparam to 2e-4 * (4e6 + 10000) / 10000.
4. For ELECTRA-Small, you also need to specifiy `"generator_hidden_size": 1.0` in the `hparams` because we did not use a small generator for that model.

#### Evaluating the pre-trained model.

To evaluate the model on a downstream task, see the below fine-tuning instructions. To evaluate the generator/discriminator on unlabelled data run `python3 run_pretraining.py --data-dir $DATA_DIR --model-name $MODEL_NAME --hparams '{"do_train": false, "do_eval": true}'`. This will print out eval metrics such as the accuracy of the generator and discriminator, and also writing the metrics out to `$DATA_DIR/$MODEL_NAME/results`.

## Fine-tuning

Use `run_finetuning.py` to fine-tune and evaluate an ELECTRA model on a downstream NLP task. It expects three arguments:

* `--data-dir`: a directory where data, model weights, etc. are stored. By default, the script loads finetuning data from `<data-dir>/finetuning_data/<task-name>` and a vocabulary from `<data-dir>/vocab.txt`.
*  `--model-name`: a name of the pre-trained model: the pre-trained weights should exist in `data-dir/models/model-name`.
* `--hparams`: a JSON dict containing model hyperparameters, data paths, etc. (e.g., `--hparams '{"task_names": ["rte"], "model_size": "base", "learning_rate": 1e-4, ...}'`). See `configure_finetuning.py` for the supported hyperparameters.  Instead of a dict, this can also be a path to a `.json` file containing the hyperparameters. You must specify the `"task_names"` and `"model_size"` (see examples below).

Eval metrics will be saved in `data-dir/model-name/results` and model weights will be saved in `data-dir/model-name/finetuning_models` by default. Evaluation is done on the dev set by default. To customize the training, add `--hparams '{"hparam1": value1, "hparam2": value2, ...}'` to the run command. Some particularly useful options:

* `"debug": true` fine-tunes a tiny ELECTRA model for a few steps.
* `"task_names": ["task_name"]`: specifies the tasks to train on. A list because the codebase nominally supports multi-task learning, (although be warned this has not been thoroughly tested).
* `"model_size": one of "small", "base", or "large"`: determines the size of the model; you must set this to the same size as the pre-trained model.
* `"do_train" and "do_eval"`: train and/or evaluate a model (both are set to true by default). For using `"do_eval": true` with `"do_train": false`, you need to specify the `init_checkpoint`, e.g., `python3 run_finetuning.py --data-dir $DATA_DIR --model-name electra_base --hparams '{"model_size": "base", "task_names": ["mnli"], "do_train": false, "do_eval": true, "init_checkpoint": "<data-dir>/models/electra_base/finetuning_models/mnli_model_1"}'`
* `"num_trials": n`: If >1, does multiple fine-tuning/evaluation runs with different random seeds.
* `"learning_rate": lr, "train_batch_size": n`, etc. can be used to change training hyperparameters.
* `"model_hparam_overrides": {"hidden_size": n, "num_hidden_layers": m}`, etc. can be used to changed the hyperparameters for the underlying transformer (the `"model_size"` flag sets the default values).

## Adding a new task
The easiest way to run on a new task is to implement a new `finetune.task.Task`, add it to `finetune.task_builder.py`, and then use `run_finetuning.py` as normal. For classification/qa/sequence tagging, you can inherit from a `finetune.classification.classification_tasks.ClassificationTask` or `finetune.tagging.tagging_tasks.TaggingTask`.  For preprocessing data, we use the same tokenizer as [BERT](https://github.com/google-research/bert).

You will need to edit the files `ProteinELECTRA/finetune/task_builder.py` then `ProteinELECTRA/finetune/classification/classification_tasks.py` or `ProteinELECTRA/finetune/tagging/tagging_tasks.py`

## Expected Results
Here are expected results for ProteinELECTRA on the various TAPE tasks, assuming you are using the pre-trained model provided.

| Task Assessing Protein Embeddings |  Test Set Score | Dev Set Score |
| --- | --- | --- | 
| Stability | 0.71 | 0.64 | 
| Remote Homology | 0.14 | 0.13 | 
| Fluorescence | 0.47 | 0.48 | 
| Secondary Structure | 0.42 | 0.43 | 

## Citation
If you use this code for your publication, please cite the original paper:
```
@inproceedings{clark2020electra,
  title = {{ELECTRA}: Pre-training Text Encoders as Discriminators Rather Than Generators},
  author = {Kevin Clark and Minh-Thang Luong and Quoc V. Le and Christopher D. Manning},
  booktitle = {ICLR},
  year = {2020},
  url = {https://openreview.net/pdf?id=r1xMH1BtvB}
}
```
And our ProteinELECTRA paper:
```
TBA
```

## Contact Info
For help or issues using ProteinELECTRA, please submit a GitHub issue.

For personal communication related to ProteinELECTRA, please contact Joseph O'Neill (Joseph.ONeill@vinelandresearch.com).
